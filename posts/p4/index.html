<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Polygon gridding using Geopandas and Shapely &#183; Blog</title><link rel=prev href=/posts/p3/><link rel=next href=/posts/p5/><meta name=description content="Intro This post will discuss some work involving maps I’ve helped a client with. The main goal of the project was collecting various datasets from web services.
 One of those web services has an endpoint that receives as a parameter a series of points that define a polygon for which the API request is made (the response will be a series of resources that are located inside that polygon). The API supports pagination, so if the area of the polygon is too big, we’ll have to do additional requests for all the result pages."><meta name=keywords content="gis,geopandas,python,maps,visualization,scraping"><meta property="og:title" content="Polygon gridding using Geopandas and Shapely"><meta property="og:description" content="Intro This post will discuss some work involving maps I’ve helped a client with. The main goal of the project was collecting various datasets from web services.
 One of those web services has an endpoint that receives as a parameter a series of points that define a polygon for which the API request is made (the response will be a series of resources that are located inside that polygon). The API supports pagination, so if the area of the polygon is too big, we’ll have to do additional requests for all the result pages."><meta property="article:published_time" content="2021-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-14T00:00:00+00:00"><meta property="og:site_name" content="Blog"><meta property="article:section" content="posts"><meta property="article:tag" content="gis"><meta property="article:tag" content="geopandas"><meta property="article:tag" content="python"><meta property="article:tag" content="maps"><meta property="article:tag" content="visualization"><meta property="article:tag" content="scraping"><meta name=twitter:card content="summary"><meta name=twitter:title content="Polygon gridding using Geopandas and Shapely"><meta name=twitter:description content="Intro This post will discuss some work involving maps I’ve helped a client with. The main goal of the project was collecting various datasets from web services.
 One of those web services has an …"><meta name=generator content="Hugo 0.79.1"><link rel=stylesheet href=/css/site.min.72989e8586a2239ea67ac4abbdb14c93dda32429d05c83e1eb621be0d97d1924.css integrity="sha256-cpiehYaiI56mesSrvbFMk92jJCnQXIPh62Ib4Nl9GSQ="></head><body class=article><header class=header><nav class=navbar><div class=navbar-brand><a class=navbar-item href=/>Blog</a>
<button class=navbar-burger data-target=topbar-nav>
<span></span><span></span><span></span></button></div><div id=topbar-nav class=navbar-menu><div class=navbar-end><a class=navbar-item href=/services/ title=Services>Services</a>
<a class=navbar-item href=/supported-tech/ title="Supported Technologies">Supported Technologies</a></div></div></nav></header><div class=body><div class=nav-container><aside class=nav><div class=panels><div class="nav-panel-menu is-active" data-panel=menu><nav class=nav-menu><h3 class=title><a href=/>Blog</a></h3><ul class=nav-list><li class=nav-item data-depth=0><button class=nav-item-toggle></button>
<a class=nav-link href=/posts/>Posts</a><ul class=nav-list><li class=nav-item data-depth=1><a class=nav-link href=/posts/p8/>Building offline archives</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p7/>Packing, encrypting and uploading deliverables</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p6/>Multiple instance Activitywatch remote server setup for time tracking</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p5/>Creating mosaics, clipping and removing overlapping satellite images</a></li><li class="nav-item is-current-page" data-depth=1><a class=nav-link href=/posts/p4/>Polygon gridding using Geopandas and Shapely</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p3/>Fast sub-tree containment checks</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p2/>Non-standard solutions to some technical problems</a></li><li class=nav-item data-depth=1><a class=nav-link href=/posts/p1/>Setting up the new blog</a></li></ul></li><li class=nav-item data-depth=0><a class=nav-link href=/services/>Services</a></li><li class=nav-item data-depth=0><a class=nav-link href=/supported-tech/>Supported Technologies</a></li></ul></nav></div><div class=nav-panel-explore data-panel=explore style=display:none><div class=context><span class=title></span><span class=version></span></div></div></div></aside></div><main class=article><div class=toolbar role=navigation><button class=nav-toggle></button>
<a href=/ class=home-link></a><nav class=breadcrumbs aria-label=breadcrumbs><ul><li><a href=/>Blog</a></li><li><a href=/posts/>Posts</a></li><li>Polygon gridding using Geopandas and Shapely</li></ul></nav></div><div class=content><article class=doc><h1 class=page>Polygon gridding using Geopandas and Shapely</h1><div class="openblock is-before-toc"><div class=title>Posted on March 14, 2021
&#183; Tagged with
<a href=/tags/gis/>gis</a>, <a href=/tags/geopandas/>geopandas</a>, <a href=/tags/python/>python</a>, <a href=/tags/maps/>maps</a>, <a href=/tags/visualization/>visualization</a>, <a href=/tags/scraping/>scraping</a></div></div><div class=sect1><h2 id=_intro>Intro</h2><div class=sectionbody><div class=paragraph><p>This post will discuss some work involving maps I’ve helped a client
with. The main goal of the project was collecting various datasets from
web services.</p></div><div class=paragraph><p>One of those web services has an endpoint that receives as a parameter a
series of points that define a polygon for which the API request is made
(the response will be a series of resources that are located inside that
polygon). The API supports pagination, so if the area of the polygon is
too big, we’ll have to do additional requests for all the result pages.</p></div><div class=paragraph><p>Since the service is localized to a specific country, it would be possible
to compute a <a href=https://en.wikipedia.org/wiki/Minimum_bounding_box>bounding box</a>
for the country, and then partition that into small rectangles of fixed dimensions
to cover the entire country.</p></div><div class=paragraph><p>But since the country surface is not of rectangular shape, this would mean
a certain volume of useless requests (outside the country’s area), since
some of those small rectangles will fall outside the country’s borders.</p></div><div class=paragraph><p>So we take a better route, and instead of the country’s bounding box,
we partition the country’s area into rectangles of certain dimensions,
and then we make API requests for each of those small rectangles.</p></div><div class=paragraph><p>We’re going to make use of <a href=https://github.com/Toblerity/Shapely>Shapely</a> and
<a href=https://geopandas.org/>GeoPandas</a> to achieve this.</p></div></div></div><div class=sect1><h2 id=_installing_geopandas_and_dependencies>Installing Geopandas and dependencies</h2><div class=sectionbody><div class=paragraph><p>Below is a set of steps that allows to build Geopandas and its dependencies.</p></div><div class=paragraph><p>The library <code>proj</code> needs to be installed. The <code>proj-bin</code> package in Debian/Ubuntu offers an old version
of the library, so we build a newer version (<code>7.2.1</code>) locally.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=bash><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 8</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 9</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>10</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>11</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>12</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>13</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>14</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>15</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>16</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>17</span></pre></div></td><td class=code><pre><span></span>sudo apt-get install libspatialindex-dev
sudo apt-get install libtiff-dev

mkdir <span style=color:#19177c>$HOME</span>/sources/
<span style=color:green>cd</span> <span style=color:#19177c>$HOME</span>/sources/
wget https://download.osgeo.org/proj/proj-7.2.1.tar.gz
tar xzvf proj-7.2.1.tar.gz
<span style=color:green>cd</span> proj-7.2.1/
./configure
make

<span style=color:green>cd</span> proj-7.2.1/src/
ln -s . bin/
<span style=color:#19177c>PROJ_DIR</span><span style=color:#666>=</span><span style=color:#ba2121>`</span><span style=color:green>pwd</span><span style=color:#ba2121>`</span>/src <span style=color:#19177c>PROJ_INCDIR</span><span style=color:#666>=</span><span style=color:#ba2121>`</span><span style=color:green>pwd</span><span style=color:#ba2121>`</span>/src <span style=color:#19177c>PROJ_LIBDIR</span><span style=color:#666>=</span><span style=color:#ba2121>`</span><span style=color:green>pwd</span><span style=color:#ba2121>`</span>/src/.libs pip3 install --user pyproj

pip3 install --user rtree
pip3 install --user pygeos
</pre></td></tr></tbody></table></code></pre></div></div></div></div><div class=sect1><h2 id=_gridding_the_countrys_area>Gridding the country’s area</h2><div class=sectionbody><div class=paragraph><p>We start out by telling <code>pyproj</code> the path to the data directory for <code>proj</code>, and defining a function
that will help with converting a Shapely Geometry object to a GeoDataFrame object that Geopandas
can plot later on.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=python><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 8</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 9</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>10</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>11</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>12</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>13</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>14</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>15</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>16</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>17</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>18</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>19</span></pre></div></td><td class=code><pre><span></span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>pyproj</span>
pyproj<span style=color:#666>.</span>datadir<span style=color:#666>.</span>set_data_dir(<span style=color:#ba2121>&#34;/home/user/sources/proj-7.2.1/data&#34;</span>)
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>geopandas</span>
<span style=color:green;font-weight:700>from</span> <span style=color:#00f;font-weight:700>fiona.crs</span> <span style=color:green;font-weight:700>import</span> from_epsg
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>numpy</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>np</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>sys</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>shapely</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>warnings</span>
warnings<span style=color:#666>.</span>filterwarnings(<span style=color:#ba2121>&#34;ignore&#34;</span>)

country_key <span style=color:#666>=</span> <span style=color:#ba2121>&#34;Spain&#34;</span>

<span style=color:#408080;font-style:italic># Convert a shapely.geometry to a GeoDataFrame</span>
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>geom_to_gdf</span>(g, label):
    gdf <span style=color:#666>=</span> geopandas<span style=color:#666>.</span>GeoDataFrame()
    gdf<span style=color:#666>.</span>crs <span style=color:#666>=</span> from_epsg(<span style=color:#666>4326</span>)
    gdf<span style=color:#666>.</span>loc[<span style=color:#666>0</span>, <span style=color:#ba2121>&#39;geometry&#39;</span>] <span style=color:#666>=</span> g
    gdf<span style=color:#666>.</span>loc[<span style=color:#666>0</span>, <span style=color:#ba2121>&#39;Location&#39;</span>] <span style=color:#666>=</span> label
    <span style=color:green;font-weight:700>return</span> gdf
</pre></td></tr></tbody></table></code></pre></div></div><div class=paragraph><p>Next, we read a GeoJSON file with all boundaries for all countries, we
turn that into a GeoDataFrame and we slice it to get the specific country
we’re interested in. Since some countries are defined by a MULTIPOLYGON
(composed of the mainland, as well as overseas regions), we get the
largest of these regions(the mainland) and extract the underlying Shapely
Geometry object.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=python><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>8</span></pre></div></td><td class=code><pre><span></span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>init_data</span>():
    <span style=color:green;font-weight:700>global</span> g_country
    df <span style=color:#666>=</span> geopandas<span style=color:#666>.</span>read_file(<span style=color:#ba2121>&#34;/home/user/Downloads/custom.geo.json&#34;</span>)
    country_regions <span style=color:#666>=</span> df[df[<span style=color:#ba2121>&#39;admin&#39;</span>] <span style=color:#666>==</span> country_key]<span style=color:#666>.</span>geometry<span style=color:#666>.</span>explode()<span style=color:#666>.</span>tolist()
    max_region <span style=color:#666>=</span> <span style=color:green>max</span>(country_regions, key<span style=color:#666>=</span><span style=color:green;font-weight:700>lambda</span> a: a<span style=color:#666>.</span>area)
    g_country <span style=color:#666>=</span> max_region

init_data()
</pre></td></tr></tbody></table></code></pre></div></div><div class=paragraph><p>Then we’ll use a bounding box, and we create a grid using the
country bounding box. We also want to have the cell width and height
configurable.</p></div><div class=paragraph><p>We go over all the cells in the bounding box and we only retain those
that intersect the country’s surface. Performing the intersection is
much faster using Shapely objects than Geopandas GeoDataFrame objects.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=python><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 8</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 9</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>10</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>11</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>12</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>13</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>14</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>15</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>16</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>17</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>18</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>19</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>20</span></pre></div></td><td class=code><pre><span></span>gdf_country <span style=color:#666>=</span> geom_to_gdf(g_country, country_key <span style=color:#666>+</span> <span style=color:#ba2121>&#39;_mainland&#39;</span>)

ax <span style=color:#666>=</span> gdf_country<span style=color:#666>.</span>plot(markersize<span style=color:#666>=.1</span>, figsize<span style=color:#666>=</span>(<span style=color:#666>16</span>, <span style=color:#666>16</span>), cmap<span style=color:#666>=</span><span style=color:#ba2121>&#39;jet&#39;</span>)

xmin, ymin, xmax, ymax<span style=color:#666>=</span> gdf_country<span style=color:#666>.</span>total_bounds

<span style=color:#408080;font-style:italic>## real cell dimensions</span>
cell_width  <span style=color:#666>=</span> <span style=color:#666>0.0817750</span>
cell_height <span style=color:#666>=</span> <span style=color:#666>0.0321233</span>

grid_cells <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> x0 <span style=color:#a2f;font-weight:700>in</span> np<span style=color:#666>.</span>arange(xmin, xmax<span style=color:#666>+</span>cell_width, cell_width ):
    <span style=color:green;font-weight:700>for</span> y0 <span style=color:#a2f;font-weight:700>in</span> np<span style=color:#666>.</span>arange(ymin, ymax<span style=color:#666>+</span>cell_height, cell_height):
        x1 <span style=color:#666>=</span> x0<span style=color:#666>-</span>cell_width
        y1 <span style=color:#666>=</span> y0<span style=color:#666>+</span>cell_height
        new_cell <span style=color:#666>=</span> shapely<span style=color:#666>.</span>geometry<span style=color:#666>.</span>box(x0, y0, x1, y1)
        <span style=color:green;font-weight:700>if</span> new_cell<span style=color:#666>.</span>intersects(g_country):
            grid_cells<span style=color:#666>.</span>append(new_cell)
        <span style=color:green;font-weight:700>else</span>:
            <span style=color:green;font-weight:700>pass</span>
</pre></td></tr></tbody></table></code></pre></div></div><div class=paragraph><p>Then we plot the country’s polygon as well as all the cells that intersect
it. This allows us to visually check if everything looks right:</p></div><div class=paragraph><p><span class=image><img src=/posts/p4-spain.png alt="p4 spain"></span></p></div><div class=paragraph><p>Finally, we write out the coordinates of every cell in a file, so our
scraper can use these coordinates in order to make API requests.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=python><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 8</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 9</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>10</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>11</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>12</span></pre></div></td><td class=code><pre><span></span>cell_df <span style=color:#666>=</span> geopandas<span style=color:#666>.</span>GeoDataFrame(grid_cells, columns<span style=color:#666>=</span>[<span style=color:#ba2121>&#39;geometry&#39;</span>], crs<span style=color:#666>=</span>from_epsg(<span style=color:#666>4326</span>))
cell_df<span style=color:#666>.</span>plot(ax<span style=color:#666>=</span>ax,facecolor<span style=color:#666>=</span><span style=color:#ba2121>&#34;none&#34;</span>, edgecolor<span style=color:#666>=</span><span style=color:#ba2121>&#39;grey&#39;</span>)

<span style=color:#408080;font-style:italic># preparing the output</span>
<span style=color:green;font-weight:700>with</span> <span style=color:green>open</span>(<span style=color:#ba2121>&#34;cells_&#34;</span> <span style=color:#666>+</span> country_key <span style=color:#666>+</span> <span style=color:#ba2121>&#34;.txt&#34;</span>, <span style=color:#ba2121>&#34;w&#34;</span>) <span style=color:green;font-weight:700>as</span> f:
    <span style=color:green;font-weight:700>for</span> cell <span style=color:#a2f;font-weight:700>in</span> grid_cells:
        <span style=color:#408080;font-style:italic># last point is excluded (since it&#39;s the same as the 1st)</span>
        bounds <span style=color:#666>=</span> []
        <span style=color:green;font-weight:700>for</span> x,y <span style=color:#a2f;font-weight:700>in</span> cell<span style=color:#666>.</span>exterior<span style=color:#666>.</span>coords[:<span style=color:#666>-1</span>]:
            x1,y1 <span style=color:#666>=</span> <span style=color:green>float</span>(<span style=color:#ba2121>&#39;</span><span style=color:#b68;font-weight:700>%.6f</span><span style=color:#ba2121>&#39;</span><span style=color:#666>%</span>(x,)) , <span style=color:green>float</span>(<span style=color:#ba2121>&#39;</span><span style=color:#b68;font-weight:700>%.6f</span><span style=color:#ba2121>&#39;</span><span style=color:#666>%</span>(y,))
            bounds<span style=color:#666>.</span>append([x1,y1])
        f<span style=color:#666>.</span>write(<span style=color:green>str</span>(bounds) <span style=color:#666>+</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>)
</pre></td></tr></tbody></table></code></pre></div></div></div></div><div class=sect1><h2 id=_writing_the_scraper>Writing the scraper</h2><div class=sectionbody><div class=paragraph><p>We now use the file <code>cells_Spain.txt</code> that we’ve generated in the previous section, as input
for our scraper.</p></div><div class=paragraph><p>We can write the scraper in many different ways(Scrapy would be one way),
but using <a href=https://www.gnu.org/software/parallel/>GNU Parallel</a>
and Bash is very effective in this case.</p></div><div class=listingblock><div class=content><pre class="pygments highlight" style=background:#f8f8f8><code data-lang=bash><table class=linenotable><tbody><tr><td class=linenos><div class=linenodiv><pre><span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 1</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 2</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 3</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 4</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 5</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 6</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 7</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 8</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px> 9</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>10</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>11</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>12</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>13</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>14</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>15</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>16</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>17</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>18</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>19</span>
<span style=color:inherit;background-color:transparent;padding-left:5px;padding-right:5px>20</span></pre></div></td><td class=code><pre><span></span><span style=color:#408080;font-style:italic>#!/bin/bash</span>

fetch_page<span style=color:#666>()</span> <span style=color:#666>{</span>
    <span style=color:#19177c>num</span><span style=color:#666>=</span><span style=color:#ba2121>&#34;</span><span style=color:#19177c>$1</span><span style=color:#ba2121>&#34;</span>
    <span style=color:#19177c>bounds</span><span style=color:#666>=</span><span style=color:#ba2121>&#34;</span><span style=color:#19177c>$2</span><span style=color:#ba2121>&#34;</span>
    <span style=color:green>echo</span> <span style=color:#ba2121>&#34;</span><span style=color:#19177c>$num</span><span style=color:#ba2121>&#34;</span>

    <span style=color:green>set</span> -x
    curl <span style=color:#b62;font-weight:700>\</span>
        -H <span style=color:#ba2121>&#39;Referer: https://www.website.com/api&#39;</span> <span style=color:#b62;font-weight:700>\</span>
        -H <span style=color:#ba2121>&#39;content-type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\</span>
        -H <span style=color:#ba2121>&#39;Origin: https://www.website.com&#39;</span> <span style=color:#b62;font-weight:700>\</span>
        --data-raw <span style=color:#ba2121>&#39;{&#34;bounds&#34;: &#39;&#34;</span><span style=color:#19177c>$bounds</span><span style=color:#ba2121>&#34;&#39;}}&#39;</span> <span style=color:#b62;font-weight:700>\</span>
        <span style=color:#ba2121>&#39;https://api.website.com/&#39;</span> &gt; data/<span style=color:#19177c>$num</span>.json
    <span style=color:green>set</span> +x
<span style=color:#666>}</span>

mkdir data
<span style=color:green>export</span> -f fetch_page
cat cells_Spain.txt | parallel --no-notice -k -j2 <span style=color:#ba2121>&#39;fetch_page {#} {}&#39;</span> :::
</pre></td></tr></tbody></table></code></pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>If you liked this article or if you have feedback and would like
to discuss more about data collection pipelines and scraping feel free to
get in touch at <a href=mailto:stefan.petrea@gmail.com>stefan.petrea@gmail.com</a>.</td></tr></tbody></table></div></div></div><nav class=pagination><span class=prev><a href=/posts/p3/>Fast sub-tree containment checks</a></span>
<span class=next><a href=/posts/p5/>Creating mosaics, clipping and removing overlapping satellite images</a></span></nav></article><aside class="toc sidebar" data-title data-levels=2><div class=toc-menu></div></aside></div></main></div><footer class=footer><p>This page was built with <a href=https://gohugo.io/>Hugo 0.79.1</a> using the <a href=https://github.com/basil/antora-default-ui-hugo-theme>Hugo port</a> of the <a href=https://gitlab.com/antora/antora-ui-default>Antora default UI</a>. The source code for this UI is licensed under the terms of the <a href=https://www.mozilla.org/en-US/MPL/2.0/>Mozilla Public License, Version 2.0</a> (MPL-2.0).</p></footer><div id=copy-to-clipboard style=display:none data-svg=/img/octicons-16.svg></div><script src=/js/site.min.da461a26436bc4ba84975879f2d7f90a593245b694bbea075400ef251e78b2e0.js integrity="sha256-2kYaJkNrxLqEl1h58tf5ClkyRbaUu+oHVADvJR54suA="></script><script src=/js/vendor/highlight.pack.79c21a0aa45cc5756c18c07f0cf37be9ad1e1b728f6f0e6b210c3913cfef592f.js integrity="sha256-ecIaCqRcxXVsGMB/DPN76a0eG3KPbw5rIQw5E8/vWS8="></script><script>;[].slice.call(document.querySelectorAll('pre code.hljs')).forEach(function(node){hljs.highlightBlock(node)})</script></body></html>